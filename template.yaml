AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  sam-app
  Sample SAM Template for sam-app

Metadata:
  TemplateConfig:
    x-db-function-properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 3
  Api:
    # This configures API Gateway to answer the browser's "OPTIONS" check
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: "'*'" # <--- Note the quoting: "'*'"

Parameters:
  CognitoUserPoolArn:
    Type: String
    Description: The ARN of the pre-existing Cognito User Pool
  DbName:
    Type: String
    Description: The database name to connect to
    Default: postgres
  LambdaSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: The Security Group to attach to the Lambda functions
  PrivateSubnetOneId:
    Type: AWS::EC2::Subnet::Id
    Description: A private subnet ID for the lambda
  PrivateSubnetTwoId:
    Type: AWS::EC2::Subnet::Id
    Description: A private subnet ID for the lambda
  PrivateSubnetThreeId:
    Type: AWS::EC2::Subnet::Id
    Description: A private subnet ID for the lambda
  PrivateSubnetFourId:
    Type: AWS::EC2::Subnet::Id
    Description: A private subnet ID for the lambda

Resources:
  RdsCertLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: RdsCertLayer
      ContentUri: layers/certs/
      CompatibleRuntimes:
        - nodejs22.x
  
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS,PATCH'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'" # <--- Note the quoting: "'*'"
      Auth:
        Authorizers:
          MyCognitoAuthorizer:
            Type: COGNITO_USER_POOLS
            UserPoolArn: !Ref CognitoUserPoolArn
        DefaultAuthorizer: MyCognitoAuthorizer
        AddDefaultAuthorizerToCorsPreflight: false 

  MatchScoringFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: match-scoring/
      Handler: app.lambdaHandler
      Events:
        CreateMatch:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /scoring/createMatch
            Method: post
        StartMatchScoring:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /scoring/{matchId}/startScoring
            Method: patch
        AddEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /scoring/{matchId}/addEvent
            Method: post
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts  

  CreateFantasyUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: auth-create-user/
      Handler: app.lambdaHandler
      Events:
        CreateUser:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /auth/createUser
            Method: post
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts  

  SeasonInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: season-info/
      Handler: app.lambdaHandler
      Events:
        SeasonInfo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /season/{seasonId}
            Method: get
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts  

  TournamentInfoFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: tournament-info/
      Handler: app.lambdaHandler
      Events:
        TournamentInfo:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /tournament/{tournamentId}
            Method: get
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts 

  UpdateProfileDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: update-profile-info/
      Handler: app.lambdaHandler
      Events:
        UpdateProfile:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /profile/{userid}
            Method: put
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts  

  GetProfileDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: get-profile-info/
      Handler: app.lambdaHandler
      Events:
        UpdateProfile:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /profile/{userid}
            Method: get
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts  

  GetMatchupsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: matchups-get/
      Handler: app.lambdaHandler
      Events:
        GetMatchups:
          Type: Api 
          Properties:
            RestApiId: !Ref MyApi
            Path: /matchups/match_num
            Method: get
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts
  
  GetLeaguesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: leagues-get/
      Handler: app.lambdaHandler
      Events:
        GetLeagues:
          Type: Api # More info about API Event Source: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#api
          Properties:
            RestApiId: !Ref MyApi
            Path: /leagues
            Method: get
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts
    # ----------------------------------------------------------
  # 1) GET ALL FANTASY TEAMS FOR USER
  #     GET /fantasy-teams?userId=<userId>
  # ----------------------------------------------------------
  GetFantasyTeamsForUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: fantasy-teams-get/
      Handler: app.lambdaHandler
      Events:
        GetFantasyTeamsForUser:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /fantasy-teams
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts

  # ----------------------------------------------------------
  # 2) GET USER'S FANTASY TEAM IN A LEAGUE
  #     GET /user-fantasy-team/by-league?leagueId=<leagueId>
  # ----------------------------------------------------------
  GetUserFantasyTeamInLeagueFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: fantasy-team-by-league/
      Handler: app.lambdaHandler
      Events:
        GetUserFantasyTeamInLeague:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /user-fantasy-team/by-league
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts

  # ----------------------------------------------------------
  # 3) GET ALL FANTASY TEAMS IN A LEAGUE
  #     GET /fantasy-teams/in-league?leagueId=<leagueId>
  # ----------------------------------------------------------
  GetFantasyTeamsInLeagueFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: fantasy-teams-in-league/
      Handler: app.lambdaHandler
      Events:
        GetFantasyTeamsInLeague:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /fantasy-teams/in-league
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts

  # ----------------------------------------------------------
  # 4) GET FANTASY TEAM INSTANCE (teamId + matchNum)
  #     GET /fantasy-team-instance?teamId=<id>&matchNum=<num>
  # ----------------------------------------------------------
  GetFantasyTeamInstanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: fantasy-team-instance-get/
      Handler: app.lambdaHandler
      Events:
        GetFantasyTeamInstance:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /fantasy-team-instance
            Method: get
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts
  
  GetMatchesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: nodejs22.x
      Architectures:
        - x86_64
      VpcConfig: 
        SecurityGroupIds:
          - !Ref LambdaSecurityGroupId
        SubnetIds:
          - !Ref PrivateSubnetOneId
          - !Ref PrivateSubnetTwoId
          - !Ref PrivateSubnetThreeId
          - !Ref PrivateSubnetFourId
      Environment:
        Variables:
          DB_HOST: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:host}}'
          DB_USER: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:username}}'
          DB_PASSWORD: '{{resolve:secretsmanager:sixers-app/db-creds:SecretString:password}}'
          DB_PORT: 5432
          DB_NAME: !Ref DbName
      Layers:
        - !Ref RdsCertLayer
      CodeUri: matches-get/
      Handler: app.lambdaHandler
      Events:
        GetHomeFeedMatches:
          Type: Api 
          Properties:
            RestApiId: !Ref MyApi
            Path: /matches/homeFeed
            Method: get
        GetSpecificMatch:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /matches/{matchId}
            Method: get
    Metadata:
      # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
          - app.ts